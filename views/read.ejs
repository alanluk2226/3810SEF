<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> - Fitness App</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <div class="container">
        <nav class="navbar">
            <div class="nav-brand">üèãÔ∏è Fitness Tracker</div>
            <div class="nav-links">
                <a href="/" class="nav-link">Home</a>
                <a href="/create" class="nav-link">Create Workout</a>
                <% if (user) { %>
                    <div class="user-info">
                        <span>Welcome, <%= user.username %>!</span>
                        <a href="/logout" class="btn btn-danger">Logout</a>
                    </div>
                <% } else { %>
                    <a href="/login" class="nav-link">Login</a>
                <% } %>
            </div>
        </nav>

        <div class="card">
            <div class="card-header">
                <h1 class="card-title">My Workouts üìä</h1>
                <p>View and search your workout history</p>
            </div>

            <div class="card-body">
                <!-- Search and Filter -->
                <div class="search-filter-section">
                    <div class="search-filter-grid">
                        <div class="form-group">
                            <label class="form-label" for="searchExercise">Search Exercise</label>
                            <input type="text" class="form-control" id="searchExercise" 
                                   placeholder="Type to search exercises...">
                            <div id="searchSuggestions" class="autocomplete-items"></div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="filterType">Exercise Type</label>
                            <select class="form-control" id="filterType">
                                <option value="">All Types</option>
                                <option value="cardio">Cardio</option>
                                <option value="strength">Strength</option>
                                <option value="flexibility">Flexibility</option>
                                <option value="balance">Balance</option>
                                <option value="high-intensity-interval-training">HIIT</option>
                                <option value="sports">Sports</option>
                                <option value="other">Other</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="filterDate">Date</label>
                            <input type="date" class="form-control" id="filterDate">
                        </div>

                        <button class="btn btn-primary btn-search" onclick="loadWorkouts()">
                            Search
                        </button>
                    </div>
                </div>

                <!-- Statistics -->
                <div class="stats-grid-read" id="workoutStats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalWorkoutsCount">0</div>
                        <div class="stat-label">Total Workouts</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalCaloriesCount">0</div>
                        <div class="stat-label">Total Calories</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalDurationCount">0</div>
                        <div class="stat-label">Total Minutes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="avgIntensity">-</div>
                        <div class="stat-label">Avg. Intensity</div>
                    </div>
                </div>

                <!-- Workouts List -->
                <div id="workoutsList">
                    <div class="loading-state">
                        <p>Loading your workouts...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allWorkouts = [];

        // Load workout data
        async function loadWorkouts() {
            try {
                const workoutsList = document.getElementById('workoutsList');
                workoutsList.innerHTML = '<div class="loading-state"><p>Loading your workouts...</p></div>';

                const response = await fetch('/api/workouts');
                const data = await response.json();
                
                if (data.success) {
                    allWorkouts = data.workouts;
                    filterAndDisplayWorkouts();
                } else {
                    throw new Error(data.error || 'Failed to load workouts');
                }
            } catch (error) {
                console.error('Error loading workouts:', error);
                document.getElementById('workoutsList').innerHTML = `
                    <div class="error-state">
                        Error loading workouts. Please try again.
                    </div>
                `;
            }
        }

        // Filter and display workouts
        function filterAndDisplayWorkouts() {
            const searchTerm = document.getElementById('searchExercise').value.toLowerCase();
            const filterType = document.getElementById('filterType').value;
            const filterDate = document.getElementById('filterDate').value;

            let filteredWorkouts = allWorkouts.filter(workout => {
                const matchesSearch = !searchTerm || 
                    workout.exerciseName.toLowerCase().includes(searchTerm);
                const matchesType = !filterType || workout.exerciseType === filterType;
                const matchesDate = !filterDate || 
                    workout.date.split('T')[0] === filterDate;
                
                return matchesSearch && matchesType && matchesDate;
            });

            displayWorkouts(filteredWorkouts);
            updateStats(filteredWorkouts);
        }

        // Display workouts list
        function displayWorkouts(workouts) {
            const container = document.getElementById('workoutsList');
            
            if (workouts.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No workouts found</h3>
                        <p>Try adjusting your search criteria or <a href="/create">create a new workout</a></p>
                    </div>
                `;
                return;
            }

            container.innerHTML = workouts.map(workout => `
                <div class="workout-card">
                    <div class="workout-header">
                        <div class="workout-title">
                            ${workout.exerciseName}
                            <span class="exercise-type-badge">${workout.exerciseType}</span>
                        </div>
                        <div class="workout-actions">
                            <a href="/update?id=${workout._id}" class="btn btn-primary">
                                Edit
                            </a>
                            <button onclick="deleteWorkout('${workout._id}')" class="btn btn-danger">
                                Delete
                            </button>
                        </div>
                    </div>
                    
                    <div class="workout-details">
                        <div class="detail-item">
                            <span class="detail-label">Date</span>
                            <span>${new Date(workout.date).toLocaleDateString()}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Duration</span>
                            <span>${workout.duration} mins</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Calories</span>
                            <span>${workout.caloriesBurned}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Intensity</span>
                            <span class="intensity-${workout.intensity}" style="text-transform: capitalize;">
                                ${workout.intensity}
                            </span>
                        </div>
                        ${workout.sets ? `
                        <div class="detail-item">
                            <span class="detail-label">Sets/Reps</span>
                            <span>${workout.sets} x ${workout.reps}</span>
                        </div>
                        ` : ''}
                        ${workout.weight ? `
                        <div class="detail-item">
                            <span class="detail-label">Weight</span>
                            <span>${workout.weight} kg</span>
                        </div>
                        ` : ''}
                        ${workout.distance ? `
                        <div class="detail-item">
                            <span class="detail-label">Distance</span>
                            <span>${workout.distance} ${workout.distanceUnit}</span>
                        </div>
                        ` : ''}
                    </div>
                    
                    ${workout.notes ? `
                    <div class="workout-notes">
                        <strong>Notes:</strong> ${workout.notes}
                    </div>
                    ` : ''}
                </div>
            `).join('');
        }

        // Update statistics
        function updateStats(workouts) {
            const totalWorkouts = workouts.length;
            const totalCalories = workouts.reduce((sum, w) => sum + (w.caloriesBurned || 0), 0);
            const totalDuration = workouts.reduce((sum, w) => sum + (w.duration || 0), 0);
            
            // Calculate average intensity
            const intensityValues = {
                'light': 1,
                'moderate': 2,
                'vigorous': 3
            };
            
            const avgIntensityValue = workouts.length > 0 ? 
                workouts.reduce((sum, w) => sum + (intensityValues[w.intensity] || 0), 0) / workouts.length : 0;
            
            let avgIntensityText = '-';
            if (avgIntensityValue > 0) {
                if (avgIntensityValue <= 1.5) avgIntensityText = 'Light';
                else if (avgIntensityValue <= 2.5) avgIntensityText = 'Moderate';
                else avgIntensityText = 'Vigorous';
            }
            
            document.getElementById('totalWorkoutsCount').textContent = totalWorkouts.toLocaleString();
            document.getElementById('totalCaloriesCount').textContent = totalCalories.toLocaleString();
            document.getElementById('totalDurationCount').textContent = totalDuration.toLocaleString();
            document.getElementById('avgIntensity').textContent = avgIntensityText;
        }

        // Delete workout
        async function deleteWorkout(workoutId) {
            if (!confirm('Are you sure you want to delete this workout? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`/api/workouts/${workoutId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    // Show success message
                    const workoutsList = document.getElementById('workoutsList');
                    workoutsList.innerHTML = `
                        <div class="success-message">
                            Workout deleted successfully! Reloading...
                        </div>
                    `;
                    
                    // Reload workouts after a short delay
                    setTimeout(loadWorkouts, 1500);
                } else {
                    alert('Error deleting workout: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error deleting workout:', error);
                alert('Error deleting workout. Please try again.');
            }
        }

        // Auto-complete functionality
        document.getElementById('searchExercise').addEventListener('input', function(e) {
            const input = e.target.value.toLowerCase();
            const suggestionsContainer = document.getElementById('searchSuggestions');
            suggestionsContainer.innerHTML = '';

            if (input.length > 0 && allWorkouts.length > 0) {
                const exerciseNames = [...new Set(allWorkouts.map(w => w.exerciseName))];
                const filtered = exerciseNames.filter(name => 
                    name.toLowerCase().includes(input)
                ).slice(0, 5);

                filtered.forEach(name => {
                    const div = document.createElement('div');
                    div.className = 'autocomplete-item';
                    div.textContent = name;
                    div.addEventListener('click', () => {
                        document.getElementById('searchExercise').value = name;
                        suggestionsContainer.innerHTML = '';
                        filterAndDisplayWorkouts();
                    });
                    suggestionsContainer.appendChild(div);
                });
            }
        });

        // Close auto-complete when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.matches('#searchExercise')) {
                document.getElementById('searchSuggestions').innerHTML = '';
            }
        });

        // Load workouts on page load
        document.addEventListener('DOMContentLoaded', loadWorkouts);

        // Listen for filter changes
        document.getElementById('filterType').addEventListener('change', filterAndDisplayWorkouts);
        document.getElementById('filterDate').addEventListener('change', filterAndDisplayWorkouts);
        document.getElementById('searchExercise').addEventListener('input', function() {
            // Add slight delay for better performance
            clearTimeout(this.searchTimeout);
            this.searchTimeout = setTimeout(filterAndDisplayWorkouts, 300);
        });
    </script>
</body>
</html>
